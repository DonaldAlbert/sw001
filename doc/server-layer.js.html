<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: server-layer.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: server-layer.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>'use strict';

var http = require('http'),
    https = require('https'),
    koa = require('koa'),
    generatorManager = require('./generator-manager');


module.exports.ServerLayer = ServerLayer;


/**
 * 
 * @class ServerBase
 */
function ServerLayer(defaultPorts, defaultSecure) {
    this.defaultPorts = defaultPorts | [];
    this.defaultSecurePorts = defaultSecure | [];
    this.portMaps = {}; // [port] -> [sites,...]
    this.servers = {}; // [port] -> [server]

    /**
     * Use this method to check if the port settings of a site are
     * compatible to those of the other sites.
     * @private
     */
    this._checkPortCompatibility = function(site) {
        var sitePorts = site.settings.ports
            , result = []
            , t = this;

        //Check site ports against eachother.
        sitePorts.plain.forEach(function(newPort){
            if( sitePorts.plain.indexOf(newPort) != -1 ) {
                result.push(newPort);
            }
        });

        //Check against default ports.
        sitePorts.plain.forEach(function(newPort){
            if( t.defaultSecurePorts.indexOf(newPort) != -1 ) {
                result.push(newPort);
            }
        });
        sitePorts.secure.forEach(function(newPort){
            if( t.defaultPorts.indexOf(newPort) != -1 ) {
                result.push(newPort);
            }
        });

        //Check against other site ports currently in use.
        sitePorts.plain.forEach(function(newPort){
            if( t.servers.keys().indexOf(newPort) != -1
                &amp;&amp; t.servers[newPort] instanceof SecureServer
                &amp;&amp; t.defaultSecurePorts.indexOf(newPort) != -1 ) {
                        result.push(newPort);
            }
        });
        sitePorts.secure.forEach(function(newPort){
            if( t.servers.keys().indexOf(newPort) != -1
                &amp;&amp; t.servers[newPort] instanceof Server
                &amp;&amp; t.defaultSecurePorts.indexOf(newPort) != -1 ) {
                        result.push(newPort);
            }
        });

        return result;
    }

    this._mapSite = function(site) {
        var sitePorts = site.settings.ports
            t = this;

        //Map plain ports
        sitePorts.plain.foreach(function(port) {
            if( t.portMaps.hasOwnPorts(port) ) {
                if( t.portMaps.indexOf(site) === -1 )
                    t.portMaps[port].push(site);
            }
            else {
                t.portMaps[port] = [site];
            }
        });


        //Map secure ports
        sitePorts.secure.foreach(function(port) {
            if( t.portMaps.hasOwnPorts(port) ) {
                if( t.portMaps.indexOf(site) === -1 )
                    t.portMaps[port].push(site);
            }
            else {
                t.portMaps[port] = [site];
            }
        });
    }

    this._unmapSite = function(site) {
        //TODO
    }

    this._mountSite = function(site) {
        //TODO
    }

    this._unmountSite = function(site) {
        //TODO
    }

    this.attachSite = function(site) {
        // Port compatibility check
        var portsOk = (this._checkPortCompatibility(site).length === 0);
        
        // Update port mapping
        this._mapSite(site);
        
        // Update corresponding server
    }

    this.detachSite = function(site) {

    }
}


/**
 * The Server class implements http server functionality for the server
 * layer of the cms. The cms uses one server object for each port of the
 * system.
 * 
 * @class Server
 */
function Server(port) {
    this.appendSite = function(site) {
        this._siteManager.push(site.getCallback(), site.name);
    }

    this.removeSite = function(site) {
        this._siteManager.remove(site.name);
    }

    this.start = function() {
        var t = this;

        return this.stopServer()
            .then(function() {
                t._server.listen(port);
            });
    }

    this.stop = function() {
        var t = this,
            resultPormise;
    
        resultPormise = new Promise(function(resolve, reject) {
            t._server.close(resolve);
        });

        return resultPromise;
    }
    
    this._koa = koa();
    this._server = http.createServer(this._koa.callback());
    this._siteManager = new GeneratorManager();
    this.serverType = 'plain';
    this.port = port;

    this._koa.use(this._siteManager.callback);
}


function SecureServer(port, options) {

}
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-bootstrap.html">bootstrap</a></li><li><a href="module-generator-manager.html">generator-manager</a></li><li><a href="module-site.html">site</a></li><li><a href="module-site-app-manager.html">site-app-manager</a></li><li><a href="module-system.html">system</a></li></ul><h3>Classes</h3><ul><li><a href="module-generator-manager-GeneratorManager.html">GeneratorManager</a></li><li><a href="module-generator-manager-OrderedManp.html">OrderedManp</a></li><li><a href="module-site-app-manager-SiteAppManager.html">SiteAppManager</a></li><li><a href="module-site-Site.html">Site</a></li><li><a href="Server.html">Server</a></li><li><a href="ServerBase.html">ServerBase</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.3.2</a> on Sat Sep 19 2015 17:16:50 GMT+0300 (EEST)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
